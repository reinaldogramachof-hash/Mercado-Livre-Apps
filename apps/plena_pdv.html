<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Plena PDV - Frente de Caixa</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        plena: { green: '#059669', dark: '#047857', black: '#1a1a1a' }, // Emerald Theme
                        success: '#10B981', danger: '#EF4444', warning: '#F59E0B'
                    }
                }
            }
        }
    </script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #ECFDF5;
            /* Emerald-50 */
            -webkit-tap-highlight-color: transparent;
            height: 100vh;
            overflow: hidden;
            /* App-like feel */
        }

        .hide {
            display: none !important;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(2px);
        }

        /* Scrollbar styles for Cart/Grid */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 3px;
        }

        /* Responsive Sidebar */
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
                position: fixed;
                z-index: 50;
                height: 100vh;
                width: 280px;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            /* Cart Overlay on Mobile */
            #cart-panel {
                position: fixed;
                bottom: 0;
                left: 0;
                width: 100%;
                height: 60vh;
                transform: translateY(100%);
                z-index: 45;
                transition: transform 0.3s ease-out;
                border-radius: 20px 20px 0 0;
                box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.2);
            }

            #cart-panel.open {
                transform: translateY(0);
            }
        }

        @media (min-width: 1025px) {
            .sidebar {
                width: 80px;
                /* Slim sidebar for PDV mode */
                position: fixed;
                height: 100vh;
                display: flex;
                flex-direction: column;
                align-items: center;
            }

            .sidebar:hover {
                width: 260px;
                align-items: stretch;
            }

            .sidebar .label {
                display: none;
            }

            .sidebar:hover .label {
                display: inline;
            }

            .main-content {
                margin-left: 80px;
                margin-right: 350px;
                /* Space for Cart */
                height: 100vh;
                overflow-y: auto;
                transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }

            /* Push content when sidebar opens */
            #sidebar:hover~.main-content {
                margin-left: 260px;
            }

            #cart-panel {
                position: fixed;
                right: 0;
                top: 0;
                width: 350px;
                height: 100vh;
                border-left: 1px solid #E5E7EB;
                background: white;
                z-index: 40;
                display: flex !important;
                flex-direction: column;
            }
        }

        /* THERMAL PRINT STYLES */
        @media print {

            /* Hide everything by default */
            body>*:not(#receipt-print) {
                display: none !important;
            }

            /* Show ONLY receipt */
            #receipt-print {
                display: block !important;
                visibility: visible !important;
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                background: white;
                color: black;
                padding: 0;
                margin: 0;
                z-index: 9999;
            }

            @page {
                size: 80mm auto;
                margin: 0;
            }
        }
    </style>
</head>

<body class="text-gray-800 antialiased flex">

    <div id="overlay" class="fixed inset-0 bg-black/50 hidden z-40 transition-opacity" onclick="toggleSidebar()"></div>
    <div id="cart-overlay" class="fixed inset-0 bg-black/50 hidden z-40 lg:hidden" onclick="toggleCart()"></div>

    <!-- SIDEBAR (Slim on Desktop for max selling space) -->
    <aside id="sidebar" class="sidebar bg-plena-black text-white transition-all duration-300 shadow-2xl">
        <div class="h-20 flex items-center justify-center lg:justify-start lg:px-6 bg-plena-green w-full shrink-0">
            <i data-lucide="store" class="w-8 h-8 lg:mr-3"></i>
            <div class="label whitespace-nowrap overflow-hidden">
                <h1 class="text-xl font-bold tracking-tight">PDV</h1>
            </div>
        </div>

        <nav class="p-2 space-y-2 flex-1 w-full mt-4">
            <button onclick="router('pos')"
                class="nav-item w-full flex items-center justify-center lg:justify-start px-2 lg:px-4 py-3 rounded-xl bg-white/10 text-white transition-all group relative">
                <i data-lucide="layout-grid" class="w-6 h-6 lg:mr-3"></i>
                <span class="label">Caixa (Venda)</span>
            </button>
            <button onclick="router('history')"
                class="nav-item w-full flex items-center justify-center lg:justify-start px-2 lg:px-4 py-3 rounded-xl text-gray-400 hover:text-white hover:bg-white/5 transition-all group relative">
                <i data-lucide="history" class="w-6 h-6 lg:mr-3"></i>
                <span class="label">Histórico</span>
            </button>
            <button onclick="router('products')"
                class="nav-item w-full flex items-center justify-center lg:justify-start px-2 lg:px-4 py-3 rounded-xl text-gray-400 hover:text-white hover:bg-white/5 transition-all group relative">
                <i data-lucide="tag" class="w-6 h-6 lg:mr-3"></i>
                <span class="label">Produtos</span>
            </button>
            <button onclick="toggleCashModal()"
                class="nav-item w-full flex items-center justify-center lg:justify-start px-2 lg:px-4 py-3 rounded-xl text-gray-400 hover:text-white hover:bg-white/5 transition-all group relative">
                <i data-lucide="dollar-sign" class="w-6 h-6 lg:mr-3"></i>
                <span class="label" id="lbl-cash">Abrir Caixa</span>
            </button>
            <button onclick="router('instructions')"
                class="nav-item w-full flex items-center justify-center lg:justify-start px-2 lg:px-4 py-3 rounded-xl text-gray-400 hover:text-white hover:bg-white/5 transition-all group relative">
                <i data-lucide="book-open" class="w-6 h-6 lg:mr-3"></i>
                <span class="label">Manual</span>
            </button>
            <button onclick="router('about')"
                class="nav-item w-full flex items-center justify-center lg:justify-start px-2 lg:px-4 py-3 rounded-xl text-gray-400 hover:text-white hover:bg-white/5 transition-all group relative">
                <i data-lucide="info" class="w-6 h-6 lg:mr-3"></i>
                <span class="label">Saiba Mais</span>
            </button>
        </nav>

        <div class="p-6 border-t border-white/10 text-center">
            <p class="text-xs text-gray-500">Todos os Direitos Reservados &copy; 2025</p>
            <a href="https://www.plenaaplicativos.com.br" target="_blank"
                class="text-[10px] text-gray-600 hover:text-plena-green transition-colors mt-1 block decoration-0">Plena
                Apps</a>
        </div>
    </aside>

    <!-- MAIN CONTENT (Product Grid) -->
    <main class="main-content flex-1 flex flex-col w-full h-full bg-[#ecfdf5]">
        <!-- Mobile Header -->
        <header class="lg:hidden bg-white h-16 flex items-center justify-between px-4 shadow-sm shrink-0">
            <button onclick="toggleSidebar()" class="p-2 text-gray-600"><i data-lucide="menu"></i></button>
            <span class="font-bold text-gray-800">Plena PDV</span>
            <button onclick="toggleCart()" class="p-2 text-plena-green relative">
                <i data-lucide="shopping-cart"></i>
                <span id="mobile-cart-count"
                    class="absolute top-0 right-0 bg-red-500 text-white text-[10px] w-4 h-4 rounded-full flex items-center justify-center font-bold">0</span>
            </button>
        </header>

        <!-- SEARCH BAR -->
        <div class="p-4 bg-white border-b border-gray-100 flex gap-4 shrink-0">
            <div class="relative flex-1">
                <i data-lucide="search" class="absolute left-3 top-3 w-5 h-5 text-gray-400"></i>
                <input type="text" id="search-box" onkeyup="filterProducts()"
                    placeholder="Buscar produto (Nome ou Código)..."
                    class="w-full pl-10 pr-4 py-3 rounded-xl border border-gray-200 bg-gray-50 focus:bg-white focus:ring-2 focus:ring-plena-green outline-none transition-all"
                    autofocus>
            </div>
            <button onclick="router('products')" class="lg:hidden p-3 bg-gray-100 rounded-xl text-gray-600"><i
                    data-lucide="tag"></i></button>
        </div>

        <!-- PRODUCT GRID -->
        <div id="view-pos" class="view-section flex-1 overflow-y-auto p-4 content-start">
            <div id="product-grid" class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-4">
                <!-- Products injected here -->
            </div>
        </div>

        <!-- OTHER VIEWS -->
        <div id="view-history" class="view-section hide flex-1 overflow-y-auto p-4">
            <h2 class="text-2xl font-bold mb-4">Histórico de Vendas</h2>
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <table class="w-full text-left text-sm">
                    <thead class="bg-gray-50 text-gray-500 uppercase font-bold text-xs">
                        <tr>
                            <th class="p-4">ID</th>
                            <th class="p-4">Data</th>
                            <th class="p-4 text-right">Total</th>
                            <th class="p-4 text-center">Ação</th>
                        </tr>
                    </thead>
                    <tbody id="sales-history" class="divide-y divide-gray-100"></tbody>
                </table>
            </div>
        </div>

        <div id="view-products" class="view-section hide flex-1 overflow-y-auto p-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Meus Produtos</h2>
                <button onclick="openProductModal()"
                    class="bg-plena-green text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2 hover:bg-plena-dark"><i
                        data-lucide="plus"></i> Novo Item</button>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
                <p class="text-sm text-gray-500 mb-4">Gerencie os itens disponíveis para venda.</p>
                <div id="manage-products-list" class="space-y-2"></div>
            </div>
        </div>

        <!-- MANUAL & ABOUT (Standardized) -->
        <div id="view-instructions" class="view-section hide flex-1 overflow-y-auto p-4">
            <div class="max-w-2xl mx-auto space-y-4">
                <h2 class="text-2xl font-bold mb-4">Manual do PDV</h2>

                <!-- ITEM 1: SECURITY -->
                <details
                    class="group bg-green-50 border border-green-100 rounded-xl overflow-hidden transition-all duration-300 open:shadow-md">
                    <summary
                        class="flex items-center justify-between p-4 cursor-pointer select-none text-green-900 font-bold">
                        <div class="flex items-center gap-3">
                            <div
                                class="w-8 h-8 rounded-full bg-green-200 flex items-center justify-center text-green-700">
                                <i data-lucide="shield-check" class="w-4 h-4"></i>
                            </div>
                            1. Segurança e Backup
                        </div>
                        <i data-lucide="chevron-down"
                            class="w-5 h-5 transition-transform group-open:rotate-180 text-green-400"></i>
                    </summary>
                    <div
                        class="p-4 pt-0 text-sm text-gray-600 bg-green-50 leading-relaxed border-t border-green-100/50">
                        <p class="mb-2"><strong>Seus dados são 100% locais.</strong> O sistema não salva nada na nuvem
                            automaticamente.</p>
                        <p>Para garantir a segurança, faça backups regularmente (exportar dados na aba Configurações se
                            disponível ou copie o arquivo de dados).</p>
                    </div>
                </details>

                <!-- ITEM 2: WORKFLOW -->
                <details
                    class="group bg-green-50 border border-green-100 rounded-xl overflow-hidden transition-all duration-300 open:shadow-md">
                    <summary
                        class="flex items-center justify-between p-4 cursor-pointer select-none text-green-900 font-bold">
                        <div class="flex items-center gap-3">
                            <div
                                class="w-8 h-8 rounded-full bg-green-200 flex items-center justify-center text-green-700">
                                <i data-lucide="shopping-cart" class="w-4 h-4"></i>
                            </div>
                            2. Como Vender (Workflow)
                        </div>
                        <i data-lucide="chevron-down"
                            class="w-5 h-5 transition-transform group-open:rotate-180 text-green-400"></i>
                    </summary>
                    <div
                        class="p-4 pt-0 text-sm text-gray-600 bg-green-50 leading-relaxed border-t border-green-100/50">
                        <ol class="list-decimal pl-5 space-y-1">
                            <li><strong>Adicionar:</strong> Clique nos produtos no grid ou use a busca para adicionar ao
                                carrinho.</li>
                            <li><strong>Quantidade:</strong> Ajuste as quantidades no painel lateral do carrinho.</li>
                            <li><strong>Cobrar:</strong> Clique em "Cobrar", informe o valor recebido e escolha o método
                                de pagamento.</li>
                            <li><strong>Imprimir:</strong> O sistema gera o cupom automaticamente.</li>
                        </ol>
                    </div>
                </details>

                <!-- ITEM 3: RECEIPTS -->
                <details
                    class="group bg-green-50 border border-green-100 rounded-xl overflow-hidden transition-all duration-300 open:shadow-md">
                    <summary
                        class="flex items-center justify-between p-4 cursor-pointer select-none text-green-900 font-bold">
                        <div class="flex items-center gap-3">
                            <div
                                class="w-8 h-8 rounded-full bg-green-200 flex items-center justify-center text-green-700">
                                <i data-lucide="receipt" class="w-4 h-4"></i>
                            </div>
                            3. Recibos e Histórico
                        </div>
                        <i data-lucide="chevron-down"
                            class="w-5 h-5 transition-transform group-open:rotate-180 text-green-400"></i>
                    </summary>
                    <div
                        class="p-4 pt-0 text-sm text-gray-600 bg-green-50 leading-relaxed border-t border-green-100/50">
                        <p>Todas as vendas ficam salvas no "Histórico". Você pode reimprimir qualquer cupom clicando no
                            ícone de impressora na lista de vendas.</p>
                    </div>
                </details>

                <!-- ITEM 4: PWA -->
                <details
                    class="group bg-green-50 border border-green-100 rounded-xl overflow-hidden transition-all duration-300 open:shadow-md">
                    <summary
                        class="flex items-center justify-between p-4 cursor-pointer select-none text-green-900 font-bold">
                        <div class="flex items-center gap-3">
                            <div
                                class="w-8 h-8 rounded-full bg-green-200 flex items-center justify-center text-green-700">
                                <i data-lucide="download" class="w-4 h-4"></i>
                            </div>
                            4. Instalar no Celular
                        </div>
                        <i data-lucide="chevron-down"
                            class="w-5 h-5 transition-transform group-open:rotate-180 text-green-400"></i>
                    </summary>
                    <div
                        class="p-4 pt-0 text-sm text-gray-600 bg-green-50 leading-relaxed border-t border-green-100/50">
                        <p class="mb-3">Use como um aplicativo nativo (sem baixar da loja):</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-3">
                            <div class="bg-white/50 p-3 rounded-lg border border-green-200">
                                <strong>Android:</strong> Chrome > 3 pontinhos > "Adicionar à Tela Inicial".
                            </div>
                            <div class="bg-white/50 p-3 rounded-lg border border-green-200">
                                <strong>iPhone:</strong> Safari > Compartilhar > "Adicionar à Tela de Início".
                            </div>
                        </div>
                    </div>
                </details>
            </div>
        </div>

        <div id="view-about" class="view-section hide flex-1 overflow-y-auto p-4">
            <div class="max-w-3xl mx-auto space-y-6">
                <div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-100">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Sobre a Plena</h2>

                    <!-- DISCLAIMER / LEGAL -->
                    <div class="bg-red-50 border-l-4 border-red-500 p-4 mb-8">
                        <div class="flex items-start">
                            <div class="flex-shrink-0">
                                <i data-lucide="alert-triangle" class="h-5 w-5 text-red-600"></i>
                            </div>
                            <div class="ml-3">
                                <h3 class="text-sm font-bold text-red-800 uppercase tracking-wide">Registro e
                                    Distribuição</h3>
                                <div class="mt-2 text-sm text-red-700 space-y-2">
                                    <p>Este software é um produto original desenvolvido pela <strong>Plena Soluções
                                            Digitais</strong>. Sua comercialização é exclusiva através de canais
                                        oficiais (Loja Oficial no Mercado Livre).</p>
                                    <p>A revenda não autorizada, engenharia reversa, cópia parcial do código-fonte ou
                                        distribuição em pacotes "piratas" constitui <strong>violação de propriedade
                                            intelectual (Lei 9.610/98)</strong>. O infrator está sujeito a sanções
                                        cíveis e criminais. Valorize o desenvolvimento nacional.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-8 text-sm text-gray-600">
                        <!-- MISSION -->
                        <div>
                            <h3 class="flex items-center text-lg font-bold text-gray-900 mb-2">
                                <i data-lucide="heart" class="w-5 h-5 mr-2 text-plena-green"></i> Nossa Missão:
                                Tecnologia e Acessibilidade
                            </h3>
                            <p class="leading-relaxed">A Plena acredita que a tecnologia deve ser um direito, não um
                                privilégio exclusivo de grandes corporações. Nossa missão é democratizar ferramentas de
                                gestão de alta performance, simples e acessíveis.</p>
                            <p class="mt-2 leading-relaxed">Desenvolvemos soluções <strong>Local-First</strong> (seus
                                dados ficam com você), garantindo que pequenos empreendedores, autônomos e famílias
                                brasileiras tenham controle total sobre suas informações, sem mensalidades abusivas e
                                sem depender de conexão constante com a internet.</p>
                        </div>

                        <!-- PRIVACY -->
                        <div class="border-t border-gray-100 pt-6">
                            <h3 class="font-bold text-gray-900 mb-2">Política de Privacidade</h3>
                            <p>Ao utilizar este sistema, você concorda que:</p>
                            <ul class="list-disc pl-5 mt-2 space-y-1">
                                <li><strong>100% Offline:</strong> Seus dados financeiros não saem deste dispositivo.
                                </li>
                                <li><strong>Responsabilidade:</strong> O backup (cópia de segurança) é responsabilidade
                                    exclusiva do usuário.</li>
                                <li><strong>Isenção:</strong> A Plena não tem acesso aos seus dados e não pode
                                    recuperá-los em caso de perda do equipamento.</li>
                            </ul>
                        </div>
                    </div>

                    <!-- CONTACT -->
                    <div class="mt-8 bg-gray-50 p-6 rounded-xl border border-gray-200">
                        <h3 class="font-bold text-gray-900 mb-2">Precisa de Suporte ou Personalização?</h3>
                        <p class="text-sm text-gray-600 mb-4">Tem uma ideia de app ou precisa adaptar este sistema para
                            seu negócio?</p>
                        <a href="mailto:tecnologia@plenainformatica.com.br"
                            class="inline-flex items-center text-plena-green font-bold hover:underline">
                            <i data-lucide="mail" class="w-4 h-4 mr-2"></i> tecnologia@plenainformatica.com.br
                        </a>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- RIGHT PANEL: CART (Always visible on Desktop, Overlay on Mobile) -->
    <div id="cart-panel" class="bg-white flex flex-col h-full border-l border-gray-200 shadow-2xl lg:shadow-none">

        <!-- Cart Header -->
        <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50 h-[80px]">
            <div>
                <h2 class="font-bold text-lg text-gray-800 flex items-center"><i data-lucide="shopping-cart"
                        class="w-5 h-5 mr-2 text-plena-green"></i> Carrinho</h2>
                <p class="text-xs text-gray-500"><span id="cart-items-count">0</span> itens adicionados</p>
            </div>
            <button onclick="toggleCart()" class="lg:hidden text-gray-400 font-bold px-2">✕</button>
            <button onclick="clearCart()"
                class="text-xs text-red-500 hover:text-red-700 font-medium hover:underline">Limpar</button>
        </div>

        <!-- Cart Items list -->
        <div id="cart-items" class="flex-1 overflow-y-auto p-2 space-y-2">
            <!-- Items injected here -->
            <div class="h-full flex flex-col items-center justify-center text-gray-300">
                <i data-lucide="shopping-bag" class="w-12 h-12 mb-2 opacity-50"></i>
                <p class="text-sm">Carrinho vazio</p>
            </div>
        </div>

        <!-- Cart Footer / Total -->
        <div class="p-4 border-t border-gray-100 bg-gray-50 mt-auto">
            <div class="flex justify-between items-end mb-4">
                <span class="text-gray-500 text-sm font-medium">Subtotal</span>
                <span id="cart-total" class="text-3xl font-bold text-gray-900 tracking-tight">R$ 0,00</span>
            </div>
            <button onclick="openCheckout()" id="btn-checkout"
                class="w-full bg-plena-green text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:bg-plena-dark transition-all active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed uppercase tracking-wide flex items-center justify-center gap-2"
                disabled>
                <span>Cobrar</span> <i data-lucide="arrow-right" class="w-5 h-5"></i>
            </button>
        </div>
    </div>

    <!-- MODALS -->

    <!-- Product Modal (Add/Edit) -->
    <div id="productModal" class="fixed inset-0 modal-backdrop hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-md p-6 shadow-2xl">
            <h3 class="font-bold text-lg mb-4">Novo Produto</h3>
            <form onsubmit="saveProduct(event)" class="space-y-3">
                <input type="hidden" id="prod-id">
                <div class="flex justify-center mb-4">
                    <div class="w-20 h-20 bg-gray-100 rounded-xl flex items-center justify-center border border-dashed border-gray-300 cursor-pointer hover:bg-gray-200"
                        onclick="alert('Funcionalidade de imagem em breve')">
                        <i data-lucide="camera" class="text-gray-400"></i>
                    </div>
                </div>
                <input type="text" id="prod-name" class="w-full border p-3 rounded-lg bg-gray-50 font-bold"
                    placeholder="Nome do Produto" required>
                <div class="grid grid-cols-2 gap-4">
                    <input type="text" id="prod-code" class="w-full border p-3 rounded-lg" placeholder="Código (Barra)">
                    <input type="number" step="0.01" id="prod-price" class="w-full border p-3 rounded-lg"
                        placeholder="Preço R$" required>
                </div>
                <button type="submit" class="w-full bg-black text-white py-3 rounded-lg font-bold mt-2">Salvar</button>
                <button type="button" onclick="closeModal('productModal')"
                    class="w-full text-gray-500 py-2">Cancelar</button>
            </form>
        </div>
    </div>

    <!-- Checkout Modal -->
    <div id="checkoutModal" class="fixed inset-0 modal-backdrop hidden z-[60] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-lg p-0 shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <div class="bg-plena-black text-white p-6 text-center">
                <p class="text-sm opacity-70 uppercase tracking-widest">Total a Pagar</p>
                <h2 id="chk-total" class="text-4xl font-bold mt-1">R$ 0,00</h2>
            </div>

            <div class="p-6 space-y-6 flex-1 overflow-y-auto">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Forma de Pagamento</label>
                    <div class="grid grid-cols-3 gap-3">
                        <button onclick="setPayment('money')"
                            class="pay-btn p-3 border rounded-xl flex flex-col items-center gap-2 hover:bg-green-50 hover:border-green-500 transition-all focus:ring-2 focus:ring-green-500 active">
                            <i data-lucide="banknote"></i> <span class="text-xs font-bold">Dinheiro</span>
                        </button>
                        <button onclick="setPayment('pix')"
                            class="pay-btn p-3 border rounded-xl flex flex-col items-center gap-2 hover:bg-green-50 hover:border-green-500 transition-all focus:ring-2 focus:ring-green-500">
                            <i data-lucide="qr-code"></i> <span class="text-xs font-bold">Pix</span>
                        </button>
                        <button onclick="setPayment('card')"
                            class="pay-btn p-3 border rounded-xl flex flex-col items-center gap-2 hover:bg-green-50 hover:border-green-500 transition-all focus:ring-2 focus:ring-green-500">
                            <i data-lucide="credit-card"></i> <span class="text-xs font-bold">Cartão</span>
                        </button>
                    </div>
                </div>

                <div id="money-section" class="transition-all">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Valor Recebido</label>
                    <div class="relative">
                        <span class="absolute left-4 top-3.5 text-gray-400 font-bold">R$</span>
                        <input type="number" id="chk-received" step="0.01" oninput="calcChange()"
                            class="w-full pl-10 pr-4 py-3 rounded-xl border border-gray-300 text-xl font-bold text-gray-800 outline-none focus:border-plena-green">
                    </div>
                </div>

                <div id="change-section"
                    class="bg-gray-100 p-4 rounded-xl flex justify-between items-center opacity-50">
                    <span class="font-bold text-gray-600">Troco</span>
                    <span id="chk-change" class="font-bold text-xl text-gray-400">R$ 0,00</span>
                </div>
            </div>

            <div class="p-6 border-t bg-gray-50">
                <button onclick="finalizeSale()"
                    class="w-full bg-plena-green text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:bg-plena-dark">
                    Confirmar Venda
                </button>
                <button onclick="closeModal('checkoutModal')"
                    class="w-full text-gray-500 py-3 mt-2 font-medium">Voltar</button>
            </div>
        </div>
    </div>
    </div>

    <!-- CASH CONTROL MODAL -->
    <div id="cashModal" class="fixed inset-0 modal-backdrop hidden z-[60] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 relative">
            <button onclick="closeModal('cashModal')" class="absolute right-4 top-4 text-gray-400"><i
                    data-lucide="x"></i></button>
            <div class="text-center mb-6">
                <div
                    class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center text-plena-green mx-auto mb-3">
                    <i data-lucide="dollar-sign" class="w-6 h-6"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-800" id="cash-title">Abrir Caixa</h3>
                <p class="text-xs text-gray-500" id="cash-subtitle">Informe o valor inicial (Fundo de Troco)</p>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Valor (R$)</label>
                    <input type="number" id="cash-val" step="0.01" value="0.00"
                        class="w-full border p-3 rounded-xl text-center text-xl font-bold text-gray-800 outline-none focus:border-plena-green">
                </div>

                <div id="cash-info" class="hidden bg-gray-50 p-3 rounded-lg text-sm space-y-2">
                    <div class="flex justify-between"><span>Vendas (Dinheiro):</span> <span class="font-bold"
                            id="ci-sales">R$ 0,00</span></div>
                    <div class="flex justify-between"><span>Abertura:</span> <span class="font-bold" id="ci-start">R$
                            0,00</span></div>
                    <div class="border-t pt-2 flex justify-between text-plena-green"><span>Esperado:</span> <span
                            class="font-bold" id="ci-expected">R$ 0,00</span></div>
                </div>

                <button onclick="confirmCashAction()"
                    class="w-full bg-plena-green text-white py-3 rounded-xl font-bold hover:bg-plena-dark">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- RECEIPT (Hidden on screen, visible on print) -->
    <div id="receipt-print" class="hidden">
        <div
            style="text-align:center; font-family: 'Courier New', monospace; font-size: 12px; line-height: 1.4; padding: 10px;">
            <h2 style="font-size: 16px; font-weight: bold; margin:0;">PLENA MARKET</h2>
            <p style="margin:0;">Rua Exemplo, 123 - Centro</p>
            <p style="margin:0;">CNPJ: 00.000.000/0001-00</p>
            <hr style="border:0; border-bottom: 1px dashed black; margin: 10px 0;">
            <p><strong>CUPOM NÃO FISCAL #<span id="rcp-id">0000</span></strong></p>
            <p id="rcp-date">00/00/0000 00:00</p>
            <hr style="border:0; border-bottom: 1px dashed black; margin: 10px 0;">
            <div id="rcp-items" style="text-align: left;">
                <!-- Items list print -->
            </div>
            <hr style="border:0; border-bottom: 1px dashed black; margin: 10px 0;">
            <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 14px;">
                <span>TOTAL</span>
                <span id="rcp-total">R$ 0,00</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span>Pagamento</span>
                <span id="rcp-pay-method">Dinheiro</span>
            </div>
            <p style="margin-top:20px; font-size: 10px;">Obrigado pela preferência!</p>
            <p style="font-size: 10px;">Sistema Plena PDV</p>
        </div>
    </div>


    <script>
        // --- STATE & DB ---
        const DB_KEY = 'plena_pdv_v1';
        let db = JSON.parse(localStorage.getItem(DB_KEY)) || {
            products: [
                { id: 1, name: 'Refrigerante 2L', price: 9.90, code: '789' },
                { id: 2, name: 'Salgado Assado', price: 6.50, code: '101' },
                { id: 3, name: 'Água Mineral', price: 3.00, code: '102' },
                { id: 4, name: 'Chocolate Barra', price: 5.99, code: '103' }
            ],
            sales: [],
            cash: { isOpen: false, turnId: null, history: [] }
        };
        const save = () => localStorage.setItem(DB_KEY, JSON.stringify(db));

        // Cart State (Transient)
        let cart = [];
        let paymentMethod = 'money';

        // --- HELPERS ---
        const fmtMoney = (v) => v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        const getID = () => Date.now().toString(36).toUpperCase().substr(-6);

        // --- INIT ---
        window.onload = () => {
            lucide.createIcons();
            router('pos');
            router('pos');
            renderProducts();
            checkCashState();

            // Integrity Check
            setInterval(() => {
                const f = document.querySelector('.sidebar');
                if (!f || !f.innerHTML.includes('Plena')) {
                    document.body.innerHTML = '<div style="background:#111;color:red;height:100vh;display:flex;align-items:center;justify-content:center;"><h1>VIOLAÇÃO DE SEGURANÇA</h1></div>';
                    throw new Error("Piracy");
                }
            }, 5000);
        };

        // --- NAVIGATION ---
        function router(view) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hide'));
            if (view === 'instructions' || view === 'about') {
                // Reuse containers or create
            }
            const el = document.getElementById(`view-${view}`);
            if (el) el.classList.remove('hide');

            // Reset nav visual
            document.querySelectorAll('.nav-item').forEach(b => b.classList.replace('bg-white/10', 'text-gray-400'));
            // Highlight current (simplification: simple active logic needed if exact match desired)

            if (window.innerWidth < 1024) document.getElementById('sidebar').classList.remove('open');

            if (view === 'products') renderManageProducts();
            if (view === 'history') renderHistory();
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('overlay').classList.toggle('hidden');
        }

        function toggleCart() {
            document.getElementById('cart-panel').classList.toggle('open');
            document.getElementById('cart-overlay').classList.toggle('hidden');
        }

        function closeModal(id) {
            document.getElementById(id).classList.add('hidden');
        }

        // --- CASH CONTROL ---
        function checkCashState() {
            const lbl = document.getElementById('lbl-cash');
            if (db.cash.isOpen) {
                lbl.innerText = 'Fechar Caixa';
                lbl.parentElement.classList.replace('text-gray-400', 'text-red-400');
            } else {
                lbl.innerText = 'Abrir Caixa';
                lbl.parentElement.classList.replace('text-red-400', 'text-gray-400');
                // Force open if trying to sell? No, let user browse but block checkout
            }
        }

        function toggleCashModal() {
            const modal = document.getElementById('cashModal');
            const title = document.getElementById('cash-title');
            const sub = document.getElementById('cash-subtitle');
            const val = document.getElementById('cash-val');
            const info = document.getElementById('cash-info');

            modal.classList.remove('hidden');
            val.value = '0.00';
            val.focus();

            if (db.cash.isOpen) {
                // CLOSING
                title.innerText = 'Fechar Caixa';
                sub.innerText = 'Conferência de valores (Dinheiro em Gaveta)';

                // Calc expected
                const turn = db.sales.filter(s => s.turnId === db.cash.turnId && s.payment === 'money');
                const salesTotal = turn.reduce((a, b) => a + b.total, 0);
                const startVal = db.cash.history[0]?.val || 0; // simplistic, ideally store in turn object

                // For this simple version, we just sum sales since last open
                // Real implementation needs robust turn tracking. 
                // We will assume 'turnId' on sales works.

                document.getElementById('ci-sales').innerText = fmtMoney(salesTotal);
                // document.getElementById('ci-start').innerText = fmtMoney(startVal); 
                // document.getElementById('ci-expected').innerText = fmtMoney(startVal + salesTotal);

                info.classList.remove('hidden');
            } else {
                // OPENING
                title.innerText = 'Abrir Caixa';
                sub.innerText = 'Informe o valor inicial (Fundo de Troco)';
                info.classList.add('hidden');
            }
        }

        function confirmCashAction() {
            const val = parseFloat(document.getElementById('cash-val').value) || 0;

            if (db.cash.isOpen) {
                // CLOSING
                db.cash.isOpen = false;
                // Calculate Totals for Report
                const turnSales = db.sales.filter(s => s.turnId === db.cash.turnId);
                const totalSales = turnSales.reduce((a, b) => a + b.total, 0);
                const moneySales = turnSales.filter(s => s.payment === 'money').reduce((a, b) => a + b.total, 0);
                const pixSales = turnSales.filter(s => s.payment === 'pix').reduce((a, b) => a + b.total, 0);
                const cardSales = turnSales.filter(s => s.payment === 'card').reduce((a, b) => a + b.total, 0);
                const startVal = db.cash.history[db.cash.history.length - 1]?.val || 0;
                // Ideally track by turnId in history too

                db.cash.history.push({ type: 'close', date: new Date(), val }); // val here is user count? or diff? Keeping simple for now

                // Prompt Print
                if (confirm('Caixa Fechado com Sucesso!\n\nDeseja imprimir o Relatório de Fechamento?')) {
                    printCashReport({
                        start: startVal,
                        total: totalSales,
                        money: moneySales,
                        pix: pixSales,
                        card: cardSales,
                        diff: val - (startVal + moneySales), // Diff based on user input 'val' (User Count) vs System Expected (Start + Money Sales)
                        userCount: val
                    });
                }

            } else {
                // OPENING
                db.cash.isOpen = true;
                db.cash.turnId = Date.now();
                db.cash.history.push({ type: 'open', date: new Date(), val });
                alert('Caixa Aberto!');
            }
            save();
            closeModal('cashModal');
            checkCashState();
        }

        function printCashReport(data) {
            const now = new Date().toLocaleString('pt-BR');
            const tr = (label, val, bold = false) => `
                <div style="display:flex; justify-content:space-between; margin-bottom:2px; font-weight:${bold ? 'bold' : 'normal'}">
                    <span>${label}</span>
                    <span>${val}</span>
                </div>`;

            const reportHTML = `
                <div style="text-align:center; font-family: 'Courier New', monospace; font-size: 11px; line-height: 1.2; padding: 0; color:black; width: 100%; max-width: 80mm; margin: 0 auto;">
                    <h2 style="font-size: 14px; font-weight: bold; margin:0;">FECHAMENTO DE CAIXA</h2>
                    <p style="font-size: 10px; margin:0;">${now}</p>
                    <hr style="border:0; border-bottom: 1px dashed black; margin: 8px 0;">
                    
                    <div style="text-align: left;">
                        ${tr('Fundo Inicial:', fmtMoney(data.start))}
                        ${tr('TOTAL VENDAS:', fmtMoney(data.total), true)}
                        <br>
                        ${tr('> Dinheiro:', fmtMoney(data.money))}
                        ${tr('> Pix:', fmtMoney(data.pix))}
                        ${tr('> Cartão:', fmtMoney(data.card))}
                        
                        <hr style="border:0; border-bottom: 1px dashed black; margin: 8px 0;">
                        
                        ${tr('CONTAGEM (User):', fmtMoney(data.userCount))}
                        ${tr('DIFERENÇA:', fmtMoney(data.diff), true)}
                    </div>
                    
                    <div style="margin-top:20px; text-align:center;">
                        <div style="border-top:1px solid black; width:60%; margin:0 auto 4px auto;"></div>
                        <p style="font-size: 10px;">Assinatura do Responsável</p>
                    </div>
                     <br>
                     <p style="font-size: 9px;">Sistema: Plena Apps</p>
                </div>
             `;
            const printArea = document.getElementById('receipt-print');
            printArea.innerHTML = reportHTML;
            setTimeout(() => window.print(), 300);
        }

        // --- CORE: PRODUCTS ---
        function renderProducts() {
            const term = document.getElementById('search-box').value.toLowerCase();
            const list = db.products.filter(p => p.name.toLowerCase().includes(term) || (p.code && p.code.includes(term)));

            document.getElementById('product-grid').innerHTML = list.map(p => `
                <div onclick="addToCart(${p.id})" class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 hover:border-plena-green hover:shadow-md transition-all cursor-pointer flex flex-col items-center text-center group active:scale-95">
                    <div class="w-12 h-12 rounded-full bg-green-50 text-plena-green flex items-center justify-center font-bold text-lg mb-3 group-hover:bg-plena-green group-hover:text-white transition-colors">
                        ${p.name.charAt(0)}
                    </div>
                    <h3 class="font-bold text-gray-800 text-sm leading-tight line-clamp-2 min-h-[40px]">${p.name}</h3>
                    <p class="text-plena-green font-bold mt-2">${fmtMoney(p.price)}</p>
                </div>
            `).join('');

            if (list.length === 0) document.getElementById('product-grid').innerHTML = '<p class="col-span-full text-center text-gray-400 mt-10">Nenhum produto encontrado.</p>';

            // Auto add if perfect code match (Scanner simulation)
            if (list.length === 1 && term.length > 2 && list[0].code === term) {
                addToCart(list[0].id);
                document.getElementById('search-box').value = '';
                filterProducts(); // Reset grid
            }
        }

        function filterProducts() {
            renderProducts();
        }

        function renderManageProducts() {
            document.getElementById('manage-products-list').innerHTML = db.products.map(p => `
                <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg">
                    <div>
                        <span class="font-bold text-gray-800">${p.name}</span>
                        <span class="text-xs text-gray-500 ml-2">#${p.code || 'S/C'}</span>
                    </div>
                    <div class="flex items-center gap-4">
                        <span class="font-bold text-plena-green">${fmtMoney(p.price)}</span>
                        <button onclick="deleteProduct(${p.id})" class="text-red-400 hover:text-red-600"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                </div>
            `).join('');
        }

        function openProductModal() {
            document.getElementById('prod-id').value = '';
            document.querySelector('form').reset();
            document.getElementById('productModal').classList.remove('hidden');
        }

        function saveProduct(e) {
            e.preventDefault();
            const name = document.getElementById('prod-name').value;
            const price = parseFloat(document.getElementById('prod-price').value);
            const code = document.getElementById('prod-code').value;

            // Quick ID gen
            const id = Date.now();
            db.products.push({ id, name, price, code });
            save(); closeModal('productModal'); renderProducts(); renderManageProducts();
        }

        function deleteProduct(id) {
            if (confirm('Excluir este produto?')) {
                db.products = db.products.filter(p => p.id !== id);
                save(); renderManageProducts(); renderProducts();
            }
        }

        // --- CORE: CART & CHECKOUT ---
        function addToCart(pid) {
            const p = db.products.find(x => x.id === pid);
            if (!p) return;

            const existing = cart.find(item => item.id === pid);
            if (existing) existing.qtd++;
            else cart.push({ ...p, qtd: 1 });

            renderCart();

            // Haptic/Visual Feedback could go here
        }

        function removeFromCart(pid) {
            cart = cart.filter(x => x.id !== pid);
            renderCart();
        }

        function adjustQtd(pid, delta) {
            const item = cart.find(x => x.id === pid);
            if (item) {
                item.qtd += delta;
                if (item.qtd <= 0) removeFromCart(pid);
                else renderCart();
            }
        }

        function clearCart() {
            if (confirm('Limpar carrinho?')) {
                cart = [];
                renderCart();
            }
        }

        function renderCart() {
            const container = document.getElementById('cart-items');
            const totalEl = document.getElementById('cart-total');
            const btn = document.getElementById('btn-checkout');
            const mobileCount = document.getElementById('mobile-cart-count');
            const itemsCount = document.getElementById('cart-items-count');

            if (cart.length === 0) {
                container.innerHTML = `<div class="h-full flex flex-col items-center justify-center text-gray-300"><i data-lucide="shopping-bag" class="w-12 h-12 mb-2 opacity-50"></i><p class="text-sm">Carrinho vazio</p></div>`;
                totalEl.innerText = fmtMoney(0);
                btn.disabled = true;
                mobileCount.innerText = 0; mobileCount.classList.add('hidden');
                itemsCount.innerText = 0;
                lucide.createIcons();
                return;
            }

            let total = 0;
            let count = 0;

            container.innerHTML = cart.map(item => {
                total += item.price * item.qtd;
                count += item.qtd;
                return `
                <div class="bg-gray-50 p-2 rounded-xl flex items-center justify-between group">
                    <div class="flex-1">
                        <p class="font-bold text-sm text-gray-800 line-clamp-1">${item.name}</p>
                        <p class="text-xs text-gray-500">${item.qtd}x ${fmtMoney(item.price)}</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="font-bold text-plena-green text-sm">${fmtMoney(item.price * item.qtd)}</span>
                        <div class="flex items-center bg-white rounded-lg border border-gray-200 h-8">
                            <button onclick="adjustQtd(${item.id}, -1)" class="w-8 h-full flex items-center justify-center hover:bg-gray-100 text-gray-600 font-bold">-</button>
                            <button onclick="adjustQtd(${item.id}, 1)" class="w-8 h-full flex items-center justify-center hover:bg-gray-100 text-gray-600 font-bold">+</button>
                        </div>
                    </div>
                </div>`;
            }).join('');

            totalEl.innerText = fmtMoney(total);
            btn.disabled = false;
            mobileCount.innerText = count;
            mobileCount.classList.remove('hidden');
            itemsCount.innerText = count;

            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
            lucide.createIcons();
        }

        function openCheckout() {
            if (!db.cash.isOpen) {
                alert('O Caixa está FECHADO. Abra o caixa para realizar vendas.');
                toggleCashModal();
                return;
            }
            const total = cart.reduce((acc, i) => acc + (i.price * i.qtd), 0);
            document.getElementById('chk-total').innerText = fmtMoney(total);
            document.getElementById('chk-received').value = '';
            document.getElementById('chk-change').innerText = 'R$ 0,00';
            setPayment('money');
            document.getElementById('checkoutModal').classList.remove('hidden');
            setTimeout(() => document.getElementById('chk-received').focus(), 100);
        }

        function setPayment(method) {
            paymentMethod = method;
            document.querySelectorAll('.pay-btn').forEach(b => {
                b.classList.remove('border-green-500', 'bg-green-50', 'ring-2');
            });
            event.currentTarget.classList.add('border-green-500', 'bg-green-50', 'ring-2'); // Note: event usage requires care, improved with direct ID approach usually

            const moneySec = document.getElementById('money-section');
            const changeSec = document.getElementById('change-section');

            if (method === 'money') {
                moneySec.classList.remove('opacity-50', 'pointer-events-none');
                changeSec.classList.remove('opacity-0');
            } else {
                moneySec.classList.add('opacity-50', 'pointer-events-none');
                changeSec.classList.add('opacity-0');
            }
        }

        // Improve pay button logic to not rely on event target being perfect
        document.querySelectorAll('.pay-btn').forEach((btn, idx) => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.pay-btn').forEach(b => b.classList.remove('border-green-500', 'bg-green-50', 'ring-2', 'ring-green-500'));
                btn.classList.add('border-green-500', 'bg-green-50', 'ring-2', 'ring-green-500');
            });
        });


        function calcChange() {
            const total = cart.reduce((acc, i) => acc + (i.price * i.qtd), 0);
            const received = parseFloat(document.getElementById('chk-received').value) || 0;
            const change = received - total;

            const el = document.getElementById('chk-change');
            if (change >= 0) {
                el.innerText = fmtMoney(change);
                el.classList.replace('text-gray-400', 'text-green-600');
                document.getElementById('change-section').classList.replace('opacity-50', 'opacity-100');
            } else {
                el.innerText = 'Falta ' + fmtMoney(Math.abs(change));
                el.classList.replace('text-green-600', 'text-red-500');
            }
        }

        function finalizeSale() {
            const total = cart.reduce((acc, i) => acc + (i.price * i.qtd), 0);
            const sale = {
                id: getID(),
                date: new Date().toISOString(),
                items: [...cart],
                total: total,
                payment: paymentMethod,
                turnId: db.cash.turnId
            };

            db.sales.unshift(sale);
            save();

            // Print Receipt - DISABLED AUTO PRINT
            // printReceipt(sale);

            // Reset
            cart = [];
            renderCart();
            closeModal('checkoutModal');

            // Optional: Ask for receipt? 
            if (confirm('Venda Realizada! Imprimir Cupom?')) {
                printReceipt(sale);
            }

            // Feedback
            // Confetti or Toast could go here
        }

        function printReceipt(sale) {
            const date = new Date(sale.date).toLocaleString('pt-BR');
            const pt = { money: 'DINHEIRO', pix: 'PIX', card: 'CARTÃO' }[sale.payment] || 'OUTROS';

            const tr = (label, val, bold = false) => `
                <div style="display:flex; justify-content:space-between; margin-bottom:2px; font-weight:${bold ? 'bold' : 'normal'}">
                    <span>${label}</span>
                    <span>${val}</span>
                </div>`;

            const itemsHtml = sale.items.map(i => `
                <div style="margin-bottom:4px;">
                    <div style="display:flex; justify-content:space-between;">
                        <span>${i.qtd}x ${i.name.substr(0, 18)}</span>
                        <span>${fmtMoney(i.price * i.qtd)}</span>
                    </div>
                </div>
            `).join('');

            const reportHTML = `
                <div style="text-align:center; font-family: 'Courier New', monospace; font-size: 11px; line-height: 1.2; padding: 0; color:black; width: 100%; max-width: 80mm; margin: 0 auto;">
                    <h2 style="font-size: 14px; font-weight: bold; margin:0; text-transform: uppercase;">PLENA PDV</h2>
                    <p style="font-size: 10px; margin:2px 0;">CUPOM NÃO FISCAL</p>
                    <p style="font-size: 10px; margin:0;">${date}</p>
                    <p style="font-size: 10px; margin:0;">Venda #${sale.id}</p>
                    <hr style="border:0; border-bottom: 1px dashed black; margin: 6px 0;">
                    
                    <div style="text-align: left;">
                        <div style="display:flex; justify-content:space-between; font-weight:bold; margin-bottom:4px; border-bottom:1px solid #000;">
                            <span>ITEM</span>
                            <span>TOTAL</span>
                        </div>
                        ${itemsHtml}
                    </div>
                    
                    <hr style="border:0; border-bottom: 1px dashed black; margin: 6px 0;">
                    
                    ${tr('TOTAL', fmtMoney(sale.total), true)}
                    <br>
                    ${tr('Forma Pagto:', pt)}
                    
                    <hr style="border:0; border-bottom: 1px dashed black; margin: 10px 0;">
                    <p style="font-size: 10px; text-align:center;">Obrigado pela preferência!</p>
                    <br>
                    <p style="font-size: 9px; text-align:center;">Sistema: Plena Apps</p>
                </div>
            `;

            const printArea = document.getElementById('receipt-print');
            printArea.innerHTML = reportHTML;
            // Delay for rendering
            setTimeout(() => window.print(), 300);
        }

        function renderHistory() {
            document.getElementById('sales-history').innerHTML = db.sales.map(s => `
                <tr class="hover:bg-gray-50">
                    <td class="p-4 font-mono text-xs text-gray-500">#${s.id}</td>
                    <td class="p-4 text-gray-800">${new Date(s.date).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })} <span class="text-xs text-gray-400 block">${new Date(s.date).toLocaleDateString()}</span></td>
                    <td class="p-4 text-right font-bold text-plena-green">${fmtMoney(s.total)}</td>
                    <td class="p-4 text-center"><button onclick="printReceipt(${JSON.stringify(s).replace(/"/g, '&quot;')})" class="p-2 text-gray-400 hover:text-black"><i data-lucide="printer" class="w-4 h-4"></i></button></td>
                </tr>
            `).join('');
            lucide.createIcons();
        }

    </script>
</body>

</html>